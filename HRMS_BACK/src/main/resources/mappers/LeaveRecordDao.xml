<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
       PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
       "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- mapper 標籤: 用來定義操作資料庫方法的 SQL 語句 -->
<!-- namespace: 用來綁定特定 Dao 介面 -->
<mapper namespace="com.example.Human_Resource_Management_System_HRMS_.dao.LeaveRecordDao">

	<resultMap id="leaveRecordMap" 
		type="com.example.Human_Resource_Management_System_HRMS_.dto.LeaveRecordDto">
	    <id property="leaveApplicationId" column="leave_application_id" />
	    <result property="employeeName" column="employee_name"/>
	    <result property="employeeId" column="employee_id" />
	    <result property="leaveType" column="leave_type" />
	    <result property="startTime" column="start_time" />
	    <result property="endTime" column="end_time" />
	    <result property="reason" column="reason" />
	    <result property="certificate" column="certificate" />
	    <result property="applyDateTime" column="apply_date_time" />
	    <result property="status" column="status" />
	    <result property="rejectionReason" column="rejection_reason" />
	    <result property="approved" column="approved" />
	    <result property="approvedDateTime" column="approved_date_time" />
	    <result property="approvalPendingRole" column="approval_pending_role" />
	    <result property="approverId" column="approver_id" />
	    <result property="submitUp" column="submit_up" />
		<result property="certificateFileType" column="certificate_file_type"/>
	</resultMap>

	<insert id="addRecord" parameterType="com.example.Human_Resource_Management_System_HRMS_.dto.LeaveRecordDto">
  		insert into leave_record (
			leave_application_id, 
			employee_name, 
			employee_id, 
			leave_type, 
			start_time, 
			end_time, 
			reason, 
			certificate, 
			apply_date_time, 
			status, 
			rejection_reason, 
			approved, 
			approved_date_time, 
			approval_pending_role, 
			approver_id, 
			submit_up,
			certificate_file_type
   		) values (
			#{leaveApplicationId}, 
			#{employeeName}, 
			#{employeeId}, 
			#{leaveType}, 
			#{startTime}, 
			#{endTime}, 
			#{reason}, 
			#{certificate}, 
			#{applyDateTime}, 
			#{status}, 
			#{rejectionReason}, 
			#{approved}, 
			#{approvedDateTime}, 
			#{approvalPendingRole}, 
			#{approverId}, 
			#{submitUp},
			#{certificateFileType})
	</insert>

	<select id="selectByLeaveIdList" resultMap="leaveRecordMap">
		select * from leave_record where leave_application_id in
			<foreach item="idItem" collection="leaveIdList" open="(" separator="," close=")">
				#{idItem}
			</foreach>
	</select>

	<select id="selectByEmployeeIdAndDate" resultMap="leaveRecordMap">
		select * from leave_record where 
		 employee_id = #{employeeId}
		 and start_time &gt;= #{startTime}
		 and end_time &lt;= #{endTime}
	</select>
	
	<update id="updateRecordToCancel">
		update leave_record set 
		 status = #{status},
		 approved = #{approved},
		 approved_date_time = #{approvedDateTime},
		 approver_id = #{approverId}
		 where leave_application_id in
 			<foreach item="idItem" collection="leaveIdList" open="(" separator="," close=")">
				#{idItem}
			</foreach>
	</update>
	
	<!-- 搜尋全部欄位，開始時間<月結束時間(AND start_time <= #{endDateOfMonth})、結束時間>月開始時間(AND end_time >= #{startDateOfMonth})、已成功申請(已審核不需上審)。 -->
	<select id="getApprovedMonthlyLeaveByEmpIdAndDate" resultMap="leaveRecordMap">
		SELECT * FROM leave_record WHERE 
		 employee_id = #{employeeId} 
		 AND start_time &lt;= #{endDateOfMonth} 
		 AND end_time &gt;= #{startDateOfMonth} 
		 AND approved IS TRUE 
		 AND submit_up IS FALSE
	</select>
	
	<select id="selectApprovedRecordByEmployeeIdAndYYMM" resultMap="leaveRecordMap">
		select * from leave_record where employee_id = #{employeeId}
		 and submit_up is false
		 and approved is true
		 and (
			(start_time between #{startTime} and #{endTime})
		 	 or (end_time between #{startTime} and #{endTime})
		 	 or (start_time &lt;= #{startTime} and end_time >= #{endTime})
		 	 )
	</select>
	
	<select id="selectByEmployeeIdAndApplyDateTime" resultMap="leaveRecordMap">
		 select * from leave_record where employee_id = #{employeeId}
		  and apply_date_time = #{applyDateTime}
	</select>

	<select id="selectAllMonthlyApprovedRecordByYYMM" resultMap="leaveRecordMap">
		select * from leave_record where submit_up is false
		 and approved is true
		 and (
			(start_time between #{startTime} and #{endTime})
		 	 or (end_time between #{startTime} and #{endTime})
		 	 or (start_time &lt;= #{startTime} and end_time >= #{endTime})
		 	 )
	</select>


 </mapper>