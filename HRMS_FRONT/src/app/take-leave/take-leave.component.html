<!-- @if(isLoading){
  <ng-container>
    <mat-spinner></mat-spinner>
  </ng-container>
}@else(){ -->

<!-- 顯示目前在哪個頁面 -->
<h4 style="margin-left: 10px; color:rgb(70, 166, 240)">請假系統</h4>

<!-- 小導覽條 -->
<div class="breadcrumb-container">
  <span class="breadcrumb" (click)="backToHome()">首頁</span>
  &nbsp;/&nbsp;
  <span class="breadcrumb" (click)="backToTakeLeave()">請假系統</span>
</div>

<div class="container-fluid page-wrapper">
  <div class="table-container left-panel">
    <div class="search-bar-wrapper" [formGroup]="dateSearch">
      <div class="search-desc">
        <h5>請選擇欲查詢之請假起訖日期</h5>
        <mat-icon matTooltip="若未填寫，系統將預設查詢區間為「今天起前一個月至後一個月」">info</mat-icon>
      </div>
      <div class="search-bar">
        <div class="startDate">
          <mat-form-field>
            <mat-label>選擇開始日期</mat-label>
            <input matInput [matDatepicker]="startDatePicker" formControlName="startDate"
              (dateChange)="onStartDateChange()">
            <mat-datepicker-toggle matIconSuffix [for]="startDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #startDatePicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="endDate">
          <mat-form-field>
            <mat-label>選擇結束日期</mat-label>
            <input matInput [matDatepicker]="endDatePicker" [min]="minEndDate" formControlName="endDate">
            <mat-datepicker-toggle matIconSuffix [for]="endDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #endDatePicker></mat-datepicker>
          </mat-form-field>
        </div>
        <div class="search-function">
          <button type="submit" class="btn search-btn" (click)="  onSearch() ">
            搜尋
          </button>
        </div>
      </div>
      <!--因為後端沒有查詢假別和狀態的功能，所以先註解，之後再看要不要新增功能-->
      <!-- <div class="leave-type">
        <mat-form-field>
          <mat-label>假別</mat-label>
          <mat-select formControlName="leaveType">
            @for (type of takeLeave.leaveTypes; track $index) {
            <mat-option [value]="type.value">{{ type.viewValue }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>
      <div class="leave-status">
        <mat-form-field>
          <mat-label>假單狀態</mat-label>
          <mat-select formControlName="leaveStatus">
            @for (status of takeLeave.leavestatus; track $index) {
            <mat-option [value]="status.value">{{ status.viewValue }}</mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div> -->
    </div>

    <div class="apply-function">
      <button type="button" class="btn apply-leave-btn" (click)="applyLeave()">
        請假申請
      </button>
    </div>

    <!--表格-->
    <table mat-table [dataSource]="dataSource" matSort>
      <!-- applyDateTime Column -->
      <ng-container matColumnDef="applyDateTime">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>申請日期</th>
        <td mat-cell *matCellDef="let element">
          {{ time.formatISODateTimeString(element.applyDateTime,false) }}
        </td>
      </ng-container>

      <!-- startTime Column -->
      <ng-container matColumnDef="startTime">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>開始時間</th>
        <td mat-cell *matCellDef="let element">
          {{ time.formatISODateTimeString(element.startTime) }}
        </td>
      </ng-container>

      <!-- endTime Column -->
      <ng-container matColumnDef="endTime">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>結束時間</th>
        <td mat-cell *matCellDef="let element">
          {{ time.formatISODateTimeString(element.endTime) }}
        </td>
      </ng-container>

      <!-- leaveType Column -->
      <ng-container matColumnDef="leaveType">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>假別</th>
        <td mat-cell *matCellDef="let element">
          {{ takeLeave.formatLeaveType(element.leaveType) }}
        </td>
      </ng-container>

      <!-- status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>狀態</th>
        <td mat-cell *matCellDef="let element">
          <button disabled [ngClass]="takeLeave.getStatusClass(element.status)"  class="status-word" >
            {{ takeLeave.formatStatus(element.status) }}
          </button>
        </td>
      </ng-container>

      <!-- detail Column -->
      <ng-container matColumnDef="detail">
        <th mat-header-cell *matHeaderCellDef>詳情</th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button class="detail-btn" (click)="takeLeave.openDetail(element)">
            <mat-icon>description</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- cancel Column -->
      
         <ng-container matColumnDef="cancel">
           <th mat-header-cell *matHeaderCellDef>取消</th>
           <td mat-cell *matCellDef="let element">
             @if(element.status.toLowerCase() === 'pending review' || element.status.toLowerCase() === 'pending
             supplement'){
             <button mat-icon-button (click)="cancelLeave(element)" matTooltip="取消假單" class="cancel-leave-btn">
               <mat-icon>close</mat-icon>
             </button>
             }
           </td>
         </ng-container>
       

      <!-- supplement Column -->
    
      <ng-container matColumnDef="supplement">
        <th mat-header-cell *matHeaderCellDef>補件</th>
        <td mat-cell *matCellDef="let element">
          @if(element.status.toLowerCase() === 'pending supplement'){
          <button mat-icon-button (click)="openSupplementDialog(element)" matTooltip="補交證明文件" class="cancel-leave-btn">
            <mat-icon>upload</mat-icon>
          </button>
          }
        </td>
      </ng-container>
      

      <!-- class="header-row-style"為更改第一列底色 -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="header-row-style"></tr>
      <!-- 斑馬紋: 滑鼠在某一欄，那一欄會出現底色 -->
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" [ngClass]="'zebra-row'">
      </tr>
    </table>

    <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons aria-label="Select page of periodic elements">
    </mat-paginator>
  </div>
</div>